name: Debug Docker Push
on:
  push:
    branches: ["main"]

jobs:
  debug-docker:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug GHCR Login and Push
        run: |
          echo "=== Environment Check ==="
          echo "Registry: ${{ secrets.REGISTRY }}"
          echo "Username: ${{ secrets.GHCR_USERNAME }}"
          echo "Token length: ${#GHCR_TOKEN}"
          
          echo "=== Docker Login ==="
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ${{ secrets.REGISTRY }} -u ${{ secrets.GHCR_USERNAME }} --password-stdin
          
          echo "=== Build Simple Test Image ==="
          GIT_SHA=$(git rev-parse --short HEAD)
          echo "Git SHA: $GIT_SHA"
          
          # Create a simple test Dockerfile
          cat > Dockerfile.test << 'EOF'
          FROM alpine:latest
          RUN echo "Test image" > /test.txt
          CMD ["cat", "/test.txt"]
          EOF
          
          echo "=== Building Test Image ==="
          docker build -f Dockerfile.test -t ${{ secrets.REGISTRY }}/test:$GIT_SHA .
          
          echo "=== Local Images ==="
          docker images | grep test
          
          echo "=== Push Test Image ==="
          if docker push ${{ secrets.REGISTRY }}/test:$GIT_SHA; then
            echo "✅ Push successful"
          else
            echo "❌ Push failed"
            exit 1
          fi
          
          echo "=== Verify Push ==="
          docker rmi ${{ secrets.REGISTRY }}/test:$GIT_SHA || true
          if docker pull ${{ secrets.REGISTRY }}/test:$GIT_SHA; then
            echo "✅ Image can be pulled back"
          else
            echo "❌ Image cannot be pulled back"
            exit 1
          fi
          
          echo "=== Test App Build ==="
          docker build -t ${{ secrets.REGISTRY }}/app:$GIT_SHA app/
          
          echo "=== App Images ==="
          docker images | grep app
          
          echo "=== Push App Image ==="
          if docker push ${{ secrets.REGISTRY }}/app:$GIT_SHA; then
            echo "✅ App push successful"
          else
            echo "❌ App push failed"
            exit 1
          fi
          
          echo "=== Final verification ==="
          docker pull ${{ secrets.REGISTRY }}/app:$GIT_SHA && echo "✅ App image accessible" || echo "❌ App image not accessible"
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
